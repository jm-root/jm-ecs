var jm=jm||{};"undefined"!=typeof module&&module.exports&&(jm=require("jm-core")),function(){jm.Component||(jm.Component=jm.TagObject.extend({_className:"component",_singleton:!0,_nameReadOnly:!1,properties:{singleton:{get:"getSignleton"},entity:{get:"getEntity"},name:{get:"getName",set:"setName"}},ctor:function(t,e){this._super(),this._entity=t,this.active=!0,e&&this.attr(e)},destroy:function(){},onAdd:function(t){},onRemove:function(t){},getName:function(){return this._name||this.classAlias||this.className},setName:function(t){this._nameReadOnly||(this._name=t)},getSignleton:function(){return this._singleton},getEntity:function(){return this._entity},toJSON:function(){return{className:this.classAlias||this.className}}}),jm.root.registries.components={component:jm.Component},jm.Component.extend=function(t){var e=jm.Class.extend.call(this,t);return e.extend=jm.Component.extend,jm.root.registries.components[e.prototype._className]=e,e})}();var jm=jm||{};if("undefined"!=typeof module&&module.exports){var _=require("lodash");jm=require("jm-core")}!function(){function t(t){var e;for(e in t)return!1;return!0}if(!jm.Entity){var e=1;jm.Entity=jm.TagObject.extend({_className:"entity",ctor:function(i){this._super(),this.entityManager=i,this._components={},this._componentsByClass={},this._componentGUID=1,this.active=!0,this.entityId=e++,Object.defineProperty(this,"components",{value:this._components,writable:!1}),Object.defineProperty(this,"componentsByClass",{value:this._componentsByClass,writable:!1}),this.on("addTag",function(t){i._entitiesByTag[t]=i._entitiesByTag[t]||{},i._entitiesByTag[t][this.entityId]=this}),this.on("removeTag",function(e){var n=i._entitiesByTag[e];n&&(delete n[this.entityId],t(n)&&delete i._entitiesByTag[e])})},destroy:function(){this.emit("destroy",this),this.removeAllComponents(),this.removeAllTags()},removeChild:function(t){this.entityManager.removeEntity(t.entityId),this.children=_.without(this.children,t),t.destroy()},removeFromParent:function(){this.parent?this.parent.removeChild(this):this.entityManager.removeEntity(this.entityId)},addComponent:function(t){var e=this._components,i=this._componentsByClass,n=t.name,s=t.className,o=n in e;if(o){if(t.singleton&&o)throw"componen already exists with the name: "+n;n=s+this._componentGUID++,t.name=n}s in i||(i[s]={});var r=i[s];return e[n]=t,r[n]=t,this[n]=t,this.addTag(s),t.classAlias&&this.addTag(t.classAlias),t.onAdd(this),t.emit("add",this),this.emit("addComponent",t),this},removeComponent:function(t){var e=this._components,i=this._componentsByClass,n=t;if("string"==typeof n&&(n=e[n]),!n)return this;var s=n.name,o=n.className,r=i[o];return delete e[s],delete r[s],delete this[s],this.removeTag(o),n.onRemove(this),n.emit("remove",this),this.emit("removeComponent",n),n.destroy(),this},removeComponents:function(t){var e=this.getComponents(t);for(i in e)this.removeComponent(i);return delete this._componentsByClass[t],this.emit("removeComponents",t),this},removeAllComponents:function(){var t=this._components;for(i in t)this.removeComponent(i);return this.emit("removeAllComponents"),this},getComponent:function(t){return this._components[t]},getComponents:function(t){return this._componentsByClass[t]},_clip:function(t,e){if(t){for(var i in e){var n=e[i],s=t[i];_.isObject(n)?(s&&this._clip(s,n),_.isEmpty(n)&&delete e[i]):n===s&&delete e[i]}}},toJSON:function(){var t=this.entityManager,e=this.type,n=t.entityType(e),s={type:e,tags:[],components:{}};s.tags=_.cloneDeep(this.tags),s.tags=_.without(s.tags,e);var o=s.components,r=this.components;for(i in r){var a=r[i];o[i]=a.toJSON(),s.tags=_.without(s.tags,i,a.className),a.classAlias&&(s.tags=_.without(s.tags,a.classAlias)),i===o[i].className&&delete o[i].className}for(i in n.tags)s.tags=_.without(s.tags,n.tags[i]);s.tags.length||delete s.tags,this._clip(n,s),r=this.children;for(i in r){var c=r[i];s.children||(s.children=[]),s.children.push(c.toJSON())}return s}})}}();var jm=jm||{};if("undefined"!=typeof module&&module.exports){var _=require("lodash");jm=require("jm-core")}!function(){if(!jm.EntityManager){var __parseConfigInfo=function(t,e){var i,n,s=_.isArray(t);return s?(i=t[e],n=null):(i=e,n=t[e]),{className:i,name:n}};jm.EntityManager=jm.EventEmitter.extend({_className:"entityManager",ctor:function(t){this._super(),this._components={},this._processors={},this._factories={},this._entityTypes={},this._pools={},this._entities={},this._entitiesByName={},this._entitiesByTag={},Object.defineProperty(this,"components",{value:this._components,writable:!1}),Object.defineProperty(this,"processors",{value:this._processors,writable:!1}),Object.defineProperty(this,"factories",{value:this._factories,writable:!1}),Object.defineProperty(this,"entityTypes",{value:this._entityTypes,writable:!1}),Object.defineProperty(this,"pools",{value:this._pools,writable:!1}),Object.defineProperty(this,"entities",{value:this._entities,writable:!1}),Object.defineProperty(this,"entitiesByName",{value:this._entitiesByName,writable:!1}),Object.defineProperty(this,"entitiesByTag",{value:this._entitiesByTag,writable:!1});var e=jm.root.registries.factories;for(var i in e){var n=new e[i](this);this.addFactory(n,i)}this.init(t)},init:function(t){t&&(this.addComponents(t.components),this.addProcessors(t.processors),this.addFactories(t.factories))},addComponents:function(opts){var bArray=_.isArray(opts);for(var key in opts){var info=__parseConfigInfo(opts,key),C=eval(info.className);this.addComponent(C,info.className,!0),this.addComponent(C,info.name)}return this},addProcessors:function(opts){for(var key in opts){var info=__parseConfigInfo(opts,key),o=eval("new "+info.className+"(this)");info.name?this.addProcessor(o,info.name):this.addProcessor(o,info.className)}return this},addFactories:function(opts){for(var key in opts){var info=__parseConfigInfo(opts,key),o=eval("new "+info.className+"(this)");this.addFactory(o,info.className),this.addFactory(o,info.name)}return this},addComponent:function(t,e,i){return t?(e?i||e!=t.prototype._className&&(t.prototype.classAlias=e):e=t.prototype._className,this._components[e]&&this.emit("warn","add Compoent already exists for "+e+", replaced."),this._components[e]=t,this.emit("addComponent",e),this):this},removeComponent:function(t){var e=this._components,i=e[t];return i&&this.emit("removeComponent",t),delete e[t],this},component:function(t){return this._components[t]},addEntityType:function(t,e){this._entityTypes[t]&&this.emit("warn","add entityType already exists for "+t+", replaced."),this._entityTypes[t]=e},addEntityTypes:function(t){for(var e in t)this.addEntityType(e,t[e])},entityType:function(t){return this._entityTypes[t]},addFactory:function(t,e){return t?(e=e||t.name||t.className,this._factories[e]&&this.emit("warn","add factory already exists for "+e+", replaced."),this._factories[e]=t,t.entityManager!=this&&(t.entityManager=this),this.emit("addFactory",t),this):this},removeFactory:function(t){var e=this._factories,i=e[t];return i&&(this.emit("removeFactory",i),delete e[t],i.destroy()),this},factory:function(t){return this._factories[t]},addProcessor:function(t,e){return t?(e||(e=t.name||t.className),this._processors[e]&&this.emit("warn","add processor already exists for "+e+", replaced."),this._processors[e]=t,t.entityManager!=this&&(t.entityManager=this),this.emit("addProcessor",t),this):this},removeProcessor:function(t){var e=this._processors,i=e[t];return i&&(this.emit("removeProcessor",i),delete e[t],i.destroy()),this},processor:function(t){return this._processors[t]},__createEntityFromPool:function(t,e,i){if(!this._entityTypes[t].poolable)return null;if(i)return null;if(e&&e.parent)return null;if(this._pools[t]){var n=this._pools[t].shift();if(n)return n.emit("reuse",e),this.addEntity(n),n}return null},createEntity:function(t,e,i){var n=null;if(n=this.__createEntityFromPool(t,e,i))return n;var s=e;e={},e=_.cloneDeep(this._entityTypes[t]),s&&(e=_.merge(e,_.cloneDeep(s)));var o=e.factory||"factory",r=this._factories[o];return r?(i&&(e.parent=i),(n=r.create(e))?(n.type=t,n.addTag(t),n.addTags(e.tags),this.addEntity(n),this.createEntityChildren(n,e),n):null):null},createEntityChildren:function(t,e){for(var i in e.children){var n=e.children[i];if(n){var s=null,o=n.className||"jm.Entity";if("jm.Entity"==o){var r=n.type;s=this.createEntity(r,n,t)}t.children||(t.children=[]),t.children.push(s)}}},addEntity:function(t,e){return t&&t.entityId?(e&&t.addTag(e),this._entities[t.entityId]=t,t.name&&(this._entitiesByName[t.name]=t),t.emit("add",this),this.emit("addEntity",t),this):this},__removeEntityToPool:function(t){var e=t.type;if(!this._entityTypes[e].poolable)return!1;if(t.parent)return!1;this._pools[e]||(this._pools[e]=[]);var i=this._pools[e];return t.emit("unuse"),i.push(t),!0},clearPool:function(t){var e=this._pools[t];e&&(this._pools[t]=[],e.forEach(function(t){t.destroy()}))},clearPools:function(){for(var t in this._pools)this.clearPool(t)},removeEntity:function(t){var e;return(e=_.isObject(t)?t:this._entities[t])?(this.removeEntityChildren(e),e.emit("remove",this),this.emit("removeEntity",e),delete this._entities[e.entityId],e.name&&delete this._entitiesByName[e.name],this.__removeEntityToPool(e)?this:(e.destroy(),this)):this},removeEntityChildren:function(t){var e=t.children;for(var i in e){var n=e[i];this.removeEntity(n.entityId)}},getEntities:function(t){var e=this._entities;if(!t)return e;var i={};if("string"==typeof t){var n,s=!1,o=!1,r=/\s*,\s*/,a=/\s+/;if(t.indexOf(",")!==-1?(o=!0,n=r):t.indexOf(" ")!==-1&&(s=!0,n=a),!s&&!o)return this._entitiesByTag[t];var c,m=t.split(n);for(var h in e){if(c=e[h],s){if(!c.hasTagAll(m))continue}else if(o&&!c.hasTagAny(m))continue;i[h]=c}}return i},getEntity:function(t){var e=this.getEntities(t);for(var i in e)return e[i];return null},update:function(t){this.emit("update",t);var e=this._processors;for(var i in e){var n=e[i];n.process(t)}}}),jm.entityManager=function(t){return new jm.EntityManager(t)}}}();var jm=jm||{};"undefined"!=typeof module&&module.exports&&(jm=require("jm-core")),function(){jm.Factory||(jm.Factory=jm.EventEmitter.extend({_className:"factory",ctor:function(t,e){this._super(e),this.entityManager=t},destory:function(){this.emit("destroy",this),this._super()},create:function(opts){var e=new jm.Entity(this.entityManager);if(!opts||!opts.components)return e;opts.parent&&(e.parent=opts.parent);var c,em=this.entityManager;for(var name in opts.components){var info=opts.components[name],className=name;info.className&&(className=info.className);var C=em.component(className);if(!C)if(C=jm.root.registries.components[className])em.addComponent(C,className);else{if(C=eval(className),C&&(C=jm.root.registries.components[C.prototype._className]),!C){em.emit("warn","can not find component "+className+", ignored");continue}em.addComponent(C,className,!0)}c=new C(e,info),info.className&&(c.name=name),e.addComponent(c)}return this.emit("create",e),e}}),jm.root.registries.factories={factory:jm.Factory},jm.Factory.extend=function(t){var e=jm.Class.extend.call(this,t);return e.extend=jm.Factory.extend,jm.root.registries.factories[e.prototype._className]=e,e})}();var jm=jm||{};"undefined"!=typeof module&&module.exports&&(jm=require("jm-core")),function(){jm.Processor||(jm.Processor=jm.EventEmitter.extend({_className:"processor",ctor:function(t,e){this._super(),this.active=!0,this.entityManager=t},destory:function(){this.emit("destroy",this),this._super()},process:function(t){if(this.active&&this.update){this.emit("process",t);var e=this.entityManager.entities;for(var i in e){var n=e[i];this.update(n,t)}}}}),jm.root.registries.processors={},jm.Processor.extend=function(t){var e=jm.Class.extend.call(this,t);return e.extend=jm.Processor.extend,jm.root.registries.processors[e.prototype._className]=e,e})}();